AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: SAM template for KSRI Admin
Parameters:
  Prefix:
    Description: Prefix to be added to resources
    Type: String
  UserPoolDomain:
    Description: domain for hosted ui
    Type: String
  useCustomDomainForUi:
    Type: String
    AllowedValues:
      - "true"
      - "false"
    Default: "true"
  UiCustomDomain:
    Description: domain for ui distribution
    Type: String
  WebsiteCustomDomain:
    Description: domain for website distribution
    Type: String
  useCustomDomainForWebsite:
    Type: String
    AllowedValues:
      - "true"
      - "false"
    Default: "true"
  isProd:
    Type: String
    AllowedValues: [true, false]
    Default: false
    Description: Set to true for production environment with provisioned throughput

Conditions:
  useCustomDomainForUiCondition: !Equals
    - !Ref useCustomDomainForUi
    - "true"
  useCustomDomainForWebsiteCondition: !Equals
    - !Ref useCustomDomainForWebsite
    - "true"
  IsProdEnvironment: !Equals [!Ref isProd, "true"]
Resources:
  customEventBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: !Sub ${Prefix}-ksri-event-bus

  # log group to have all events from event bus
  eventBusLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/events/${Prefix}-ksri-event-bus-logs
      RetentionInDays: 30

  eventBusLogRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName: !GetAtt customEventBus.Name
      Name: !Sub ${Prefix}-ksri-event-bus-log-rule
      Description: "Rule to log all events from the event bus"
      State: ENABLED
      EventPattern:
        source:
          - prefix: ""
      Targets:
        - Id: LogTarget
          Arn: !GetAtt eventBusLogGroup.Arn

  expressAPI:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${Prefix}_admin_api
      CodeUri: express-api/
      Handler: index.handler
      Timeout: 30
      MemorySize: 256
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      FunctionUrlConfig:
        AuthType: NONE
        Cors:
          AllowOrigins:
            - "*"
          AllowMethods:
            - "*"
          AllowHeaders:
            - "*"

      ReservedConcurrentExecutions: 15
      Environment:
        Variables:
          DDB_TABLE_NAME: !Ref masterTable
          POWERTOOLS_SERVICE_NAME: express-api
          POWERTOOLS_METRICS_NAMESPACE: ksriadmin
          LOG_LEVEL: INFO
          USER_POOL_ID: !Ref CognitoUserPool
          CLIENT_ID: !Ref ProdCognitoUserPoolClient
          BASE_URL: "https://ksri.in/"
          EMAIL_PARAM_NAME: "/loops/ksri/key"
          EVENT_BUS_NAME: !GetAtt customEventBus.Name
          CC_AVENUE_CREDS: "/ksri/ccavenue"
          CLOUDFLARE_SECRET_KEY: "/cloudflare/trunstile"
          # ALLOWED_URL: !If
          #   - useCustomDomainForUiCondition
          #   - !Ref UiCustomDomain
          #   - !Sub https://${UiDistribution.DomainName}
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref masterTable
        - DynamoDBReadPolicy:
            TableName: !Ref masterTable
        - DynamoDBWritePolicy:
            TableName: !Ref masterTable
        - SSMParameterReadPolicy:
            ParameterName: "*"
        # event bridge publish permission
        - Statement:
            - Effect: Allow
              Action:
                - events:*

              Resource: !GetAtt customEventBus.Arn
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - cognito-idp:*
              Resource: "*"
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        EntryPoints:
          - index.ts
        External:
          - pdfmake

  paymentSuccessHandler:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${Prefix}_payment_success_handler
      CodeUri: express-api/src/payment_success_response
      Handler: index.handler
      Timeout: 30
      MemorySize: 256
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      ReservedConcurrentExecutions: 2
      Environment:
        Variables:
          DDB_TABLE_NAME: !Ref masterTable
          POWERTOOLS_SERVICE_NAME: contact-us
          POWERTOOLS_METRICS_NAMESPACE: ksriadmin
          LOG_LEVEL: INFO
          GOOGLE_API_PARAM_NAME: "/google/drive"
          FOLDER_ID: "1qt1gT7MD6asR2KUPwTbDxr0s0AAs3KkA"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref masterTable
        - DynamoDBReadPolicy:
            TableName: !Ref masterTable
        - DynamoDBWritePolicy:
            TableName: !Ref masterTable
        - SSMParameterReadPolicy:
            ParameterName: "*"
      Events:
        PaymentCompletedEvent:
          Type: EventBridgeRule
          Properties:
            EventBusName: !GetAtt customEventBus.Name
            Pattern:
              detail-type:
                - payment.completed
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        EntryPoints:
          - index.ts
        External:
          - pdfmake

  eventBridgeRoleToSQS:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${Prefix}_eventBridge_to_SQS_role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: EventBridgeToSQSPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                Resource: !GetAtt paymentInitQueue.Arn

  paymentInitEventRuleToSQS:
    Type: AWS::Events::Rule
    Properties:
      Description: "Rule to send payment init event to SQS"
      EventBusName: !GetAtt customEventBus.Name
      Name: !Sub ${Prefix}_payment_init_event_to_sqs
      State: ENABLED
      EventPattern:
        detail-type:
          - payment.initiate
      Targets:
        - Id: SendEventToSQS
          Arn: !GetAtt paymentInitQueue.Arn
          RoleArn: !GetAtt eventBridgeRoleToSQS.Arn

          # DeadLetterConfig:
          #   Arn: !GetAtt paymentInitDlq.Arn

  paymentInitQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub ${Prefix}_payment_init_queue
      VisibilityTimeout: 30
      DelaySeconds: 900
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt paymentInitQueueDLQ.Arn
        maxReceiveCount: 3

  paymentInitQueueDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub ${Prefix}_payment_init_queue_dlq

  paymentInit:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${Prefix}_payment_init_handler
      CodeUri: express-api/src/payment_init/
      Handler: index.handler
      Timeout: 30
      MemorySize: 256
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      ReservedConcurrentExecutions: 2
      Environment:
        Variables:
          DDB_TABLE_NAME: !Ref masterTable
          POWERTOOLS_SERVICE_NAME: contact-us
          POWERTOOLS_METRICS_NAMESPACE: ksriadmin
          LOG_LEVEL: INFO
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref masterTable
        - DynamoDBReadPolicy:
            TableName: !Ref masterTable
        - DynamoDBWritePolicy:
            TableName: !Ref masterTable
        - SSMParameterReadPolicy:
            ParameterName: "*"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - sqs:SendMessage
                - sqs:ReceiveMessage
                - sqs:DeleteMessage
                - sqs:GetQueueAttributes
              Resource: !GetAtt paymentInitQueue.Arn
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt paymentInitQueue.Arn
            BatchSize: 1

    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        EntryPoints:
          - index.ts

  contactUs:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${Prefix}_contact_us_api
      CodeUri: contact_us/
      Handler: index.handler
      Timeout: 30
      MemorySize: 256
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      FunctionUrlConfig:
        AuthType: NONE
        Cors:
          AllowOrigins:
            - "*"
          AllowMethods:
            - "*"
          AllowHeaders:
            - "*"
      ReservedConcurrentExecutions: 2
      Environment:
        Variables:
          DDB_TABLE_NAME: !Ref masterTable
          POWERTOOLS_SERVICE_NAME: contact-us
          POWERTOOLS_METRICS_NAMESPACE: ksriadmin
          LOG_LEVEL: INFO
          USER_POOL_ID: !Ref CognitoUserPool
          CLIENT_ID: !Ref ProdCognitoUserPoolClient
          # ALLOWED_URL: !If
          #   - useCustomDomainForUiCondition
          #   - !Ref UiCustomDomain
          #   - !Sub https://${UiDistribution.DomainName}
          FROM_EMAIL: "info@ksri.in"
          TO_EMAIL: "ksrinst@gmail.com"

      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref masterTable
        - DynamoDBReadPolicy:
            TableName: !Ref masterTable
        - DynamoDBWritePolicy:
            TableName: !Ref masterTable
        - SSMParameterReadPolicy:
            ParameterName: "*"
        # ses:SendEmail
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - ses:SendEmail
                - ses:SendRawEmail
              Resource: "*"
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        EntryPoints:
          - index.ts

  dashboardScheduleLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${Prefix}_admin_dashboard_schedule
      CodeUri: dashboard_stats/
      Handler: index.handler
      Timeout: 30
      MemorySize: 256
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Environment:
        Variables:
          DDB_TABLE_NAME: !Ref masterTable
          LOG_LEVEL: INFO
          S3_BUCKET_NAME: !Ref S3Bucket
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref masterTable
        - DynamoDBReadPolicy:
            TableName: !Ref masterTable
        - DynamoDBWritePolicy:
            TableName: !Ref masterTable
        # cloudwatch:GetMetricData
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - cloudwatch:GetMetricData
              Resource: "*"
      Events:
        Schedule:
          Type: Schedule
          Properties:
            Schedule: rate(3 hours)

    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        EntryPoints:
          - index.ts
        External:
          - "@aws-sdk/lib-dynamodb"
          - "@aws-sdk/client-dynamodb"

  masterTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    Properties:
      TableName: !Sub ${Prefix}_admin_master_table
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: publishedStatus
          AttributeType: S
        - AttributeName: collection
          AttributeType: S
        - AttributeName: status
          AttributeType: S
        - AttributeName: paymentDate
          AttributeType: S
        - AttributeName: bookId
          AttributeType: S
        - AttributeName: email
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      BillingMode: !If [IsProdEnvironment, "PROVISIONED", "PAY_PER_REQUEST"]
      ProvisionedThroughput: !If
        - IsProdEnvironment
        - ReadCapacityUnits: 5
          WriteCapacityUnits: 5
        - !Ref "AWS::NoValue"
      GlobalSecondaryIndexes:
        - IndexName: PkPublishedStatusIndex
          KeySchema:
            - AttributeName: PK
              KeyType: HASH
            - AttributeName: publishedStatus
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput: !If
            - IsProdEnvironment
            - ReadCapacityUnits: 1
              WriteCapacityUnits: 1
            - !Ref "AWS::NoValue"
        - IndexName: PkProjectStatus
          KeySchema:
            - AttributeName: PK
              KeyType: HASH
            - AttributeName: status
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput: !If
            - IsProdEnvironment
            - ReadCapacityUnits: 3
              WriteCapacityUnits: 3
            - !Ref "AWS::NoValue"
        - IndexName: CollectionSK
          KeySchema:
            - AttributeName: collection
              KeyType: HASH
            - AttributeName: SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput: !If
            - IsProdEnvironment
            - ReadCapacityUnits: 1
              WriteCapacityUnits: 1
            - !Ref "AWS::NoValue"
        - IndexName: PaymentDateIndex
          KeySchema:
            - AttributeName: PK
              KeyType: HASH
            - AttributeName: paymentDate
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput: !If
            - IsProdEnvironment
            - ReadCapacityUnits: 3
              WriteCapacityUnits: 3
            - !Ref "AWS::NoValue"
        - IndexName: email-BookIdIndex
          KeySchema:
            - AttributeName: email
              KeyType: HASH
            - AttributeName: bookId
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput: !If
            - IsProdEnvironment
            - ReadCapacityUnits: 3
              WriteCapacityUnits: 3
            - !Ref "AWS::NoValue"

  S3Bucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Sub ${Prefix}-admin-store
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - "*"
            AllowedMethods:
              - PUT
              - POST
              - DELETE
              - GET
            AllowedOrigins:
              - "*"
            ExposedHeaders: []

  S3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref S3Bucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action:
              - s3:GetObject
            Effect: Allow
            Resource: !Join
              - ""
              - - "arn:aws:s3:::"
                - !Ref S3Bucket
                - /*
            Principal:
              Service: cloudfront.amazonaws.com
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub arn:aws:cloudfront::${AWS::AccountId}:distribution/${imageDistribution}

  S3BucketForLogs:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Sub ${Prefix}-image-distribution-access-logs
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred
      AccessControl: AwsExecRead
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldObjects
            Status: Enabled
            ExpirationInDays: 365
            Prefix: "" # Apply to all objects in the bucket

  imageDistribution:
    Type: AWS::CloudFront::Distribution
    DependsOn:
      - S3Bucket
      - S3BucketForLogs
    Properties:
      DistributionConfig:
        Origins:
          - DomainName: !GetAtt S3Bucket.DomainName
            Id: myS3Origin
            OriginAccessControlId: !Ref cloudfrontoriginaccessControl
            S3OriginConfig: {}
        Enabled: "true"
        Comment: !Sub image distribution for ${S3Bucket}
        HttpVersion: http2and3
        DefaultCacheBehavior:
          ForwardedValues:
            QueryString: "false"
            Cookies:
              Forward: none
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          TargetOriginId: myS3Origin
          ResponseHeadersPolicyId: "5cc3b908-e619-4b99-88e5-2cf7f45965bd"
          ViewerProtocolPolicy: redirect-to-https
        PriceClass: PriceClass_200
        Logging:
          IncludeCookies: "false"
          Bucket: !GetAtt S3BucketForLogs.DomainName
          Prefix: cloudfront-access-logs/
        ViewerCertificate:
          CloudFrontDefaultCertificate: "true"

  cloudfrontoriginaccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !GetAtt S3Bucket.DomainName
        OriginAccessControlOriginType: s3
        SigningBehavior: no-override
        SigningProtocol: sigv4

  # S3 For ebook
  S3BucketForEbook:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Sub ${Prefix}-ebook-store
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - "*"
            AllowedMethods:
              - PUT
              - POST
              - DELETE
              - GET
            AllowedOrigins:
              - "*"
            ExposedHeaders: []

  # S3 Bucket Policy for ebook
  S3BucketPolicyForEbook:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref S3BucketForEbook
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action:
              - s3:GetObject
            Effect: Allow
            Resource: !Join
              - ""
              - - "arn:aws:s3:::"
                - !Ref S3BucketForEbook
                - /*
            Principal:
              Service: cloudfront.amazonaws.com
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub arn:aws:cloudfront::${AWS::AccountId}:distribution/${ebookDistribution}

  S3BucketForLogsEbook:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Sub ${Prefix}-ebook-distribution-access-logs
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred
      AccessControl: AwsExecRead
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldObjects
            Status: Enabled
            ExpirationInDays: 365
            Prefix: "" # Apply to all objects in the bucket

  CloudFrontPublicKey:
    Type: AWS::CloudFront::PublicKey
    Properties:
      PublicKeyConfig:
        CallerReference: !Ref "AWS::StackName"
        Name: !Sub EbookSigningKey-${Prefix}
        EncodedKey: |
          -----BEGIN PUBLIC KEY-----
          MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAzACEw1KnFCBQEQe5owUr
          xHbiLx+09kmMCcladdz3mT1PGpe5+J/tIxiVP2QtZp0VloUJhR5HGV9I5wT/cx5c
          yDzA+pjGGVYaab5vloowS6F+TC5KoV1vLEYDU+2NKBic6+/OM7FQFrpMQfN7pvn1
          zYjrzliaxEE05FCe4FhxYMeDawHk2HhBEO9n1VWd/etuAPXu4huUxSZE0tQB9qRb
          aYgdcI4qepRwBcHvjEkYGc5vMgc/6PMCJc18a3nKZ0XoNFcJtIwmPQRP4PLC1VZL
          cXzF1YWnJK5WkwbDmRkE4FybJZ57af+cQZvxznJF4+pIX+JjIrltYGMkk61LGYc8
          EQIDAQAB
          -----END PUBLIC KEY-----

  CloudFrontKeyGroup:
    Type: AWS::CloudFront::KeyGroup
    Properties:
      KeyGroupConfig:
        Items:
          - !Ref CloudFrontPublicKey
        Name: !Sub EbookKeyGroup-${Prefix}

  # CloudFront Distribution with Signed URL configuration
  ebookDistribution:
    Type: AWS::CloudFront::Distribution
    DependsOn:
      - S3BucketForEbook
      - S3BucketForLogsEbook
    Properties:
      DistributionConfig:
        Origins:
          - DomainName: !GetAtt S3BucketForEbook.DomainName
            Id: myS3Origin
            OriginAccessControlId: !Ref cloudfrontoriginaccessControlEbook
            S3OriginConfig: {}
        Enabled: "true"
        Comment: !Sub ebook distribution for ${S3BucketForEbook}
        HttpVersion: http2and3
        DefaultCacheBehavior:
          TrustedKeyGroups:
            - !Ref CloudFrontKeyGroup
          ForwardedValues:
            QueryString: "false"
            Cookies:
              Forward: none
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          TargetOriginId: myS3Origin
          Compress: false
          CachePolicyId: "658327ea-f89d-4fab-a63d-7e88639e58f6"
          ResponseHeadersPolicyId: "5cc3b908-e619-4b99-88e5-2cf7f45965bd"
          ViewerProtocolPolicy: redirect-to-https
          # LambdaFunctionAssociations:
          #   - EventType: viewer-request
          #     LambdaFunctionARN: !Sub arn:aws:lambda:us-east-1:${AWS::AccountId}:function:${Prefix}-request-inspection-edge:2
        PriceClass: PriceClass_200
        Logging:
          IncludeCookies: "false"
          Bucket: !GetAtt S3BucketForLogsEbook.DomainName
          Prefix: cloudfront-access-logs/
        ViewerCertificate:
          CloudFrontDefaultCertificate: "true"

  cloudfrontoriginaccessControlEbook:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !GetAtt S3BucketForEbook.DomainName
        OriginAccessControlOriginType: s3
        SigningBehavior: no-override
        SigningProtocol: sigv4

  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub ${Prefix}_admin_user_pool
      AdminCreateUserConfig:
        AllowAdminCreateUserOnly: true
      MfaConfiguration: OPTIONAL
      # AliasAttributes:
      #   - email
      UsernameConfiguration:
        CaseSensitive: false
      EnabledMfas:
        - SOFTWARE_TOKEN_MFA

  CognitoAdminGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: !Sub admin
      UserPoolId: !Ref CognitoUserPool

  CognitoReadOnlyGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: !Sub read_only
      UserPoolId: !Ref CognitoUserPool

  CognitoSuperAdminGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: !Sub super_admin
      UserPoolId: !Ref CognitoUserPool

  CognitoUserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      Domain: !Ref UserPoolDomain
      UserPoolId: !Ref CognitoUserPool
  CognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub ${Prefix}_admin_app_client
      UserPoolId: !Ref CognitoUserPool
      CallbackURLs:
        - http://localhost:3000/
      LogoutURLs:
        - http://localhost:3000/
      AllowedOAuthFlowsUserPoolClient: true
      AllowedOAuthScopes:
        - email
        - phone
        - openid
        - profile
        - aws.cognito.signin.user.admin
      AllowedOAuthFlows:
        - code
      SupportedIdentityProviders:
        - COGNITO
  UserPoolHostedUI:
    Type: AWS::Cognito::UserPoolUICustomizationAttachment
    DependsOn:
      - CognitoUserPoolDomain
      - CognitoUserPoolClient
    Properties:
      ClientId: !Ref CognitoUserPoolClient
      UserPoolId: !Ref CognitoUserPool
      CSS: |-
        .logo-customizable { max-width: 60%; max-height: 30%; }
        .banner-customizable { padding: 25px 0px 25px 0px; background-color: #F3F9FA; }
        .label-customizable { font-weight: 400; }
        .textDescription-customizable { padding-top: 10px; padding-bottom: 10px; display: block; font-size: 16px; }
        .idpDescription-customizable { padding-top: 10px; padding-bottom: 10px; display: block; font-size: 16px; }
        .legalText-customizable { color: #747474; font-size: 11px; }
        .submitButton-customizable { font-size: 14px; font-weight: bold; margin: 20px 0px 10px 0px; height: 40px; width: 100%; color: #fff; background-color: #5AB55E; }
        .submitButton-customizable:hover { color: #fff; background-color: #16A583; }
        .errorMessage-customizable { padding: 5px; font-size: 14px; width: 100%; background: #F5F5F5; border: 2px solid #D64958; color: #D64958; }
        .inputField-customizable { width: 100%; height: 34px; color: #555; background-color: #fff; border: 1px solid #ccc; }
        .inputField-customizable:focus { border-color: #66afe9; outline: 0; }
        .idpButton-customizable { height: 40px; width: 100%; width: 100%; text-align: center; margin-bottom: 15px; color: #fff; background-color: #5bc0de; border-color: #46b8da; }
        .idpButton-customizable:hover { color: #fff; background-color: #31b0d5; }
        .socialButton-customizable { border-radius: 2px; height: 40px; margin-bottom: 15px; padding: 1px; text-align: left; width: 100%; }
        .redirect-customizable { text-align: center; }
        .passwordCheck-notValid-customizable { color: #DF3312; }
        .passwordCheck-valid-customizable { color: #19BF00; }
        .background-customizable { /* background-color: #fff; */ box-shadow: 0px 2px 20px rgba(0, 0, 0, 20%), 0 0 0 10000px white; }

  ProdCognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub ${Prefix}_prod_app_client
      UserPoolId: !Ref CognitoUserPool
      CallbackURLs:
        - !If
          - useCustomDomainForUiCondition
          - !Ref UiCustomDomain
          - !Sub https://${UiDistribution.DomainName}/
      LogoutURLs:
        - !If
          - useCustomDomainForUiCondition
          - !Ref UiCustomDomain
          - !Sub https://${UiDistribution.DomainName}/
      AllowedOAuthFlowsUserPoolClient: true
      AllowedOAuthScopes:
        - email
        - phone
        - openid
        - profile
        - aws.cognito.signin.user.admin
      AllowedOAuthFlows:
        - code
      SupportedIdentityProviders:
        - COGNITO
  ProdUserPoolHostedUI:
    Type: AWS::Cognito::UserPoolUICustomizationAttachment
    DependsOn:
      - CognitoUserPoolDomain
      - ProdCognitoUserPoolClient
    Properties:
      ClientId: !Ref ProdCognitoUserPoolClient
      UserPoolId: !Ref CognitoUserPool
      CSS: |-
        .logo-customizable { max-width: 60%; max-height: 30%; }
        .banner-customizable { padding: 25px 0px 25px 0px; background-color: #F3F9FA; }
        .label-customizable { font-weight: 400; }
        .textDescription-customizable { padding-top: 10px; padding-bottom: 10px; display: block; font-size: 16px; }
        .idpDescription-customizable { padding-top: 10px; padding-bottom: 10px; display: block; font-size: 16px; }
        .legalText-customizable { color: #747474; font-size: 11px; }
        .submitButton-customizable { font-size: 14px; font-weight: bold; margin: 20px 0px 10px 0px; height: 40px; width: 100%; color: #fff; background-color: #5AB55E; }
        .submitButton-customizable:hover { color: #fff; background-color: #16A583; }
        .errorMessage-customizable { padding: 5px; font-size: 14px; width: 100%; background: #F5F5F5; border: 2px solid #D64958; color: #D64958; }
        .inputField-customizable { width: 100%; height: 34px; color: #555; background-color: #fff; border: 1px solid #ccc; }
        .inputField-customizable:focus { border-color: #66afe9; outline: 0; }
        .idpButton-customizable { height: 40px; width: 100%; width: 100%; text-align: center; margin-bottom: 15px; color: #fff; background-color: #5bc0de; border-color: #46b8da; }
        .idpButton-customizable:hover { color: #fff; background-color: #31b0d5; }
        .socialButton-customizable { border-radius: 2px; height: 40px; margin-bottom: 15px; padding: 1px; text-align: left; width: 100%; }
        .redirect-customizable { text-align: center; }
        .passwordCheck-notValid-customizable { color: #DF3312; }
        .passwordCheck-valid-customizable { color: #19BF00; }
        .background-customizable { /* background-color: #fff; */ box-shadow: 0px 2px 20px rgba(0, 0, 0, 20%), 0 0 0 10000px white; }

  CognitoIdentityPool:
    Type: AWS::Cognito::IdentityPool
    Properties:
      IdentityPoolName: !Sub ${Prefix}_ksriadmin_identity_pool
      AllowUnauthenticatedIdentities: false
      CognitoIdentityProviders:
        - ClientId: !Ref CognitoUserPoolClient
          ProviderName: !GetAtt CognitoUserPool.ProviderName
        - ClientId: !Ref ProdCognitoUserPoolClient
          ProviderName: !GetAtt CognitoUserPool.ProviderName
  CognitoIdentityPoolRoleAttachment:
    Type: AWS::Cognito::IdentityPoolRoleAttachment
    Properties:
      IdentityPoolId: !Ref CognitoIdentityPool
      Roles:
        authenticated: !GetAtt CognitoAuthRole.Arn
  CognitoAuthRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${Prefix}_admin_CognitoAuthRole
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Federated: cognito-identity.amazonaws.com
            Action:
              - sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                cognito-identity.amazonaws.com:aud: !Ref CognitoIdentityPool
      Policies:
        - PolicyName: CognitoAuthPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - mobileanalytics:PutEvents
                  - cognito-sync:*
                  - cognito-identity:*
                Resource: "*"
              - Effect: Allow
                Action:
                  - dynamodb:*
                Resource:
                  - !GetAtt masterTable.Arn
                  - !Sub ${masterTable.Arn}/index/*
              - Effect: Allow
                Action:
                  - s3:*
                Resource:
                  - !GetAtt S3Bucket.Arn
                  - !Sub ${S3Bucket.Arn}/*
                  - !GetAtt S3BucketForEbook.Arn
                  - !Sub ${S3BucketForEbook.Arn}/*

  AmplifyApp:
    Type: AWS::Amplify::App
    Properties:
      Name: !Sub ${Prefix}-admin-amplify
      # redirect
      CustomRules:
        - Source: /<*>
          Target: /index.html
          Status: 404
        - Source: </^[^.]+$|\.(?!(css|gif|ico|jpg|js|png|txt|svg|woff|woff2|ttf|map|json)$)([^.]+$)/>
          Target: /
          Status: 200
  UiDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Origins:
          - ConnectionAttempts: 3
            ConnectionTimeout: 10
            CustomOriginConfig:
              HTTPPort: 80
              HTTPSPort: 443
              OriginKeepaliveTimeout: 5
              OriginProtocolPolicy: https-only
              OriginReadTimeout: 30
              OriginSSLProtocols:
                - TLSv1.2
            DomainName: !Sub prod.${AmplifyApp.DefaultDomain}
            Id: uiOrigin
            OriginPath: ""
        DefaultCacheBehavior:
          ForwardedValues:
            QueryString: "false"
            Cookies:
              Forward: none
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          TargetOriginId: uiOrigin
          ViewerProtocolPolicy: redirect-to-https
        Comment: !Sub ${Prefix} ksriadmin amplify
        PriceClass: PriceClass_200
        Enabled: true
        ViewerCertificate:
          CloudFrontDefaultCertificate: true

  S3BucketForWebsiteZip:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Sub ${Prefix}-website-zip-s3
      # make bucket public
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false

  S3BucketPolicyForWebsiteZip:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref S3BucketForWebsiteZip
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal: "*"
            Action: "s3:GetObject"
            Resource: !Sub arn:aws:s3:::${S3BucketForWebsiteZip}/*

  # website amplify with cloudfront
  websiteAmplifyApp:
    Type: AWS::Amplify::App
    Properties:
      Name: !Sub ${Prefix}-website-amplify
      # redirect
      CustomRules:
        - Source: /<*>
          Target: /index.html
          Status: 404
  # create a branch for website
  websiteAmplifyBranch:
    Type: AWS::Amplify::Branch
    Properties:
      AppId: !GetAtt websiteAmplifyApp.AppId
      BranchName: prod
  # cloudfront distribution for website
  websiteDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Origins:
          - ConnectionAttempts: 3
            ConnectionTimeout: 10
            CustomOriginConfig:
              HTTPPort: 80
              HTTPSPort: 443
              OriginKeepaliveTimeout: 5
              OriginProtocolPolicy: https-only
              OriginReadTimeout: 30
              OriginSSLProtocols:
                - TLSv1.2
            DomainName: !Sub prod.${websiteAmplifyApp.DefaultDomain}
            Id: uiOrigin
            OriginPath: ""
        DefaultCacheBehavior:
          ForwardedValues:
            QueryString: "false"
            Cookies:
              Forward: none
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          TargetOriginId: uiOrigin
          ViewerProtocolPolicy: redirect-to-https
        Comment: !Sub ${Prefix} website amplify
        PriceClass: PriceClass_200
        Enabled: true
        ViewerCertificate:
          CloudFrontDefaultCertificate: true

  #preview website with cloudfront
  previewDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Origins:
          - ConnectionAttempts: 3
            ConnectionTimeout: 10
            CustomOriginConfig:
              HTTPPort: 80
              HTTPSPort: 443
              OriginKeepaliveTimeout: 5
              OriginProtocolPolicy: https-only
              OriginReadTimeout: 30
              OriginSSLProtocols:
                - TLSv1.2
            DomainName: !Sub preview.${websiteAmplifyApp.DefaultDomain}
            Id: uiOrigin
            OriginPath: ""
        DefaultCacheBehavior:
          ForwardedValues:
            QueryString: "false"
            Cookies:
              Forward: none
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          TargetOriginId: uiOrigin
          ViewerProtocolPolicy: redirect-to-https
        Comment: !Sub ${Prefix} preview amplify
        PriceClass: PriceClass_200
        Enabled: true
        ViewerCertificate:
          CloudFrontDefaultCertificate: true

  APIDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub ${Prefix}-api-dashboard
      DashboardBody: !Sub |
        {
          "widgets": [
            {
                "type": "log",
                "x": 0,
                "y": 54,
                "width": 12, 
                "height": 6,
                "properties": {
                  "query": "SOURCE '/aws/lambda/${Prefix}_admin_api' | fields @timestamp, path, responseTime, username, userId, statusCode\n| filter component = 'middleware' and method = 'POST'\n| sort @timestamp desc\n| limit 100",
                  "region": "${AWS::Region}",
                  "title": "POST Requests",
                  "view": "table"
                }
            },
            {
              "type": "log",
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '/aws/lambda/${Prefix}_admin_api' | fields @timestamp, statusCode, path, responseTime, userAgent, ip\n| filter component = 'middleware'\n| sort @timestamp desc\n| limit 100",
                "region": "${AWS::Region}",
                "title": "Recent API Requests",
                "view": "table"
              }
            },
            {
              "type": "log",
              "x": 12,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '/aws/lambda/${Prefix}_admin_api' | fields @timestamp, statusCode, path, error,username, userId, correlationId\n| filter component = 'middleware' and statusCode >= 400\n| sort @timestamp desc\n| limit 100",
                "region": "${AWS::Region}",
                "title": "API Errors",
                "view": "table"
              }
            },
            {
              "type": "log",
              "x": 0,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '/aws/lambda/${Prefix}_admin_api' | fields path, responseTime\n| filter component = 'middleware' and responseTime > 0\n| stats count(*) as requests, avg(responseTime) as avgResponseTime, max(responseTime) as maxResponseTime, pct(responseTime, 95) as p95ResponseTime by path\n| sort avgResponseTime desc",
                "region": "${AWS::Region}",
                "title": "Response Time Analysis",
                "view": "table"
              }
            },
            {
              "type": "log",
              "x": 12,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '/aws/lambda/${Prefix}_admin_api' | fields @timestamp, userId, username, path, statusCode, userAgent\n| filter component = 'middleware' and isPresent(userId)\n| sort @timestamp desc\n| limit 100",
                "region": "${AWS::Region}",
                "title": "User Activity",
                "view": "table"
              }
            },
            {
              "type": "log",
              "x": 0,
              "y": 12,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '/aws/lambda/${Prefix}_admin_api' | fields @timestamp, path, error, ip, userAgent, correlationId\n| filter component = 'middleware' and statusCode = 401\n| sort @timestamp desc",
                "region": "${AWS::Region}",
                "title": "Authentication Failures",
                "view": "table"
              }
            },
            {
              "type": "log",
              "x": 12,
              "y": 12,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '/aws/lambda/${Prefix}_admin_api' | fields path, method\n| filter component = 'middleware'\n| stats count(*) as requests by path, method\n| sort requests desc",
                "region": "${AWS::Region}",
                "title": "Traffic by Path",
                "view": "table"
              }
            },
            {
              "type": "log",
              "x": 0,
              "y": 18,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '/aws/lambda/${Prefix}_admin_api' | fields @timestamp, path, responseTime,username, userId, statusCode\n| filter component = 'middleware' and responseTime > 1000\n| sort responseTime desc",
                "region": "${AWS::Region}",
                "title": "High Response Time Requests",
                "view": "table"
              }
            },
            {
              "type": "log",
              "x": 12,
              "y": 18,
              "width": 12,
              "height": 6,
              "properties": {
                "query": "SOURCE '/aws/lambda/${Prefix}_admin_api' | fields username, @timestamp\n| filter component = 'middleware' and isPresent(username)\n| stats min(@timestamp) as sessionStart, max(@timestamp) as sessionEnd, count(*) as requestCount by username\n| sort requestCount desc",
                "region": "${AWS::Region}",
                "title": "User Session Analysis",
                "view": "table"
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 24,
              "width": 12,
              "height": 6, 
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", "FunctionName", "${Prefix}_admin_api", { "stat": "Sum", "period": 300 }]
                ],
                "region": "${AWS::Region}",
                "title": "Lambda Requests",
                "view": "timeSeries",
                "stacked": false,
                "period": 300
              }
            },
            {
              "type": "metric", 
              "x": 12,
              "y": 24,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Errors", "FunctionName", "${Prefix}_admin_api", { "stat": "Sum", "period": 300 }]
                ],
                "region": "${AWS::Region}",
                "title": "Lambda Errors",
                "view": "timeSeries",
                "stacked": false,
                "period": 300
              }
            },
            {
              "type": "metric",
              "x": 0, 
              "y": 30,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Duration", "FunctionName", "${Prefix}_admin_api", { "stat": "Average", "period": 300 }]
                ],
                "region": "${AWS::Region}",
                "title": "Lambda Duration",
                "view": "timeSeries",
                "stacked": false,
                "period": 300
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 30, 
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "ConcurrentExecutions", "FunctionName", "${Prefix}_admin_api", { "stat": "Maximum", "period": 300 }]
                ],
                "region": "${AWS::Region}",
                "title": "Lambda Concurrent Executions",
                "view": "timeSeries",
                "stacked": false,
                "period": 300
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 36,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/DynamoDB", "ConsumedReadCapacityUnits", "TableName", "${Prefix}_admin_master_table", { "stat": "Sum", "period": 300 }]
                ],
                "region": "${AWS::Region}",
                "title": "DynamoDB Read Capacity Units",
                "view": "timeSeries", 
                "stacked": false,
                "period": 300
              }
            },
            {
              "type": "metric", 
              "x": 12,
              "y": 36,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/DynamoDB", "ConsumedWriteCapacityUnits", "TableName", "${Prefix}_admin_master_table", { "stat": "Sum", "period": 300 }]
                ],
                "region": "${AWS::Region}",
                "title": "DynamoDB Write Capacity Units", 
                "view": "timeSeries",
                "stacked": false,
                "period": 300
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 42,
              "width": 12, 
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/CloudFront", "Requests", "DistributionId", "${imageDistribution}", { "stat": "Sum", "period": 300 }],
                  ["AWS/CloudFront", "Requests", "DistributionId", "${UiDistribution}", { "stat": "Sum", "period": 300 }],
                  ["AWS/CloudFront", "Requests", "DistributionId", "${websiteDistribution}", { "stat": "Sum", "period": 300 }]
                ],
                "region": "us-east-1",
                "title": "CloudFront Requests",
                "view": "timeSeries",
                "stacked": false,
                "period": 300
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 42,
              "width": 12,
              "height": 6, 
              "properties": {
                "metrics": [
                  ["AWS/CloudFront", "4xxErrorRate", "DistributionId", "${imageDistribution}", { "stat": "Average", "period": 300 }],
                  ["AWS/CloudFront", "4xxErrorRate", "DistributionId", "${UiDistribution}", { "stat": "Average", "period": 300 }],
                  ["AWS/CloudFront", "4xxErrorRate", "DistributionId", "${websiteDistribution}", { "stat": "Average", "period": 300 }],
                  ["AWS/CloudFront", "5xxErrorRate", "DistributionId", "${imageDistribution}", { "stat": "Average", "period": 300 }],
                  ["AWS/CloudFront", "5xxErrorRate", "DistributionId", "${UiDistribution}", { "stat": "Average", "period": 300 }],
                  ["AWS/CloudFront", "5xxErrorRate", "DistributionId", "${websiteDistribution}", { "stat": "Average", "period": 300 }]
                ],
                "region": "us-east-1",
                "title": "CloudFront Error Rates",
                "view": "timeSeries",
                "stacked": false,
                "period": 300
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 48,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/CloudFront", "BytesDownloaded", "DistributionId", "${imageDistribution}", { "stat": "Sum", "period": 300 }],
                  ["AWS/CloudFront", "BytesDownloaded", "DistributionId", "${UiDistribution}", { "stat": "Sum", "period": 300 }],
                  ["AWS/CloudFront", "BytesDownloaded", "DistributionId", "${websiteDistribution}", { "stat": "Sum", "period": 300 }]
                ],
                "region": "us-east-1",
                "title": "CloudFront Bytes Downloaded",
                "view": "timeSeries",
                "stacked": false,
                "period": 300
              }
            },
            {
              "type": "metric", 
              "x": 12,
              "y": 48,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/CloudFront", "TotalErrorRate", "DistributionId", "${imageDistribution}", { "stat": "Average", "period": 300 }],
                  ["AWS/CloudFront", "TotalErrorRate", "DistributionId", "${UiDistribution}", { "stat": "Average", "period": 300 }],
                  ["AWS/CloudFront", "TotalErrorRate", "DistributionId", "${websiteDistribution}", { "stat": "Average", "period": 300 }]
                ],
                "region": "us-east-1",
                "title": "CloudFront Total Error Rate",
                "view": "timeSeries",
                "stacked": false, 
                "period": 300
              }
            }
          ]
        }

  WebsiteUserPool:
    Type: "AWS::Cognito::UserPool"
    Properties:
      UserPoolName: !Sub ${Prefix}_website_user_pool
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true
          TemporaryPasswordValidityDays: 7
      LambdaConfig: {}
      Schema:
        - Name: "name"
          AttributeDataType: "String"
          DeveloperOnlyAttribute: false
          Mutable: true
          Required: false
          StringAttributeConstraints:
            MinLength: "0"
            MaxLength: "2048"
        - Name: "preferred_username"
          AttributeDataType: "String"
          DeveloperOnlyAttribute: false
          Mutable: true
          Required: false
          StringAttributeConstraints:
            MinLength: "0"
            MaxLength: "2048"
        - Name: "email"
          AttributeDataType: "String"
          DeveloperOnlyAttribute: false
          Mutable: true
          Required: true
          StringAttributeConstraints:
            MinLength: "0"
            MaxLength: "2048"
        - Name: "email_verified"
          AttributeDataType: "Boolean"
          DeveloperOnlyAttribute: false
          Mutable: true
          Required: false
      AutoVerifiedAttributes:
        - "email"
      UsernameAttributes:
        - "email"
      MfaConfiguration: "OFF"
      EmailConfiguration:
        EmailSendingAccount: "COGNITO_DEFAULT"
      AdminCreateUserConfig:
        AllowAdminCreateUserOnly: false
      UserPoolTags: {}
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Priority: 1
            Name: "verified_email"
          - Priority: 2
            Name: "verified_phone_number"
      UsernameConfiguration:
        CaseSensitive: false
      VerificationMessageTemplate:
        DefaultEmailOption: "CONFIRM_WITH_CODE"
      EmailVerificationMessage: |
        <p> Sir / Madam
        <br/>
        <br/>
         We received your request for a confirmation code to create KSRI e-book account login.
         <br/>
         Your verification code is: <b>{####}</b>
         <br/><br/>
         Thanks
         <br/>
         The KSRI Team<p>
      EmailVerificationSubject: KSRI E-book Login Verification Code
      SmsVerificationMessage: Hello Sir/Ma'am, Your verification code to sign up to KSRI Website is {####}. Thanks!

  CognitoUserPoolDomainForWebsite:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      Domain: !Sub ${Prefix}-website
      UserPoolId: !Ref WebsiteUserPool
      ManagedLoginVersion: 2

  # UserPoolClient
  WebsiteUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub ${Prefix}_website_app_client
      UserPoolId: !Ref WebsiteUserPool
      CallbackURLs:
        - !If
          - useCustomDomainForWebsiteCondition
          - !Ref WebsiteCustomDomain
          - !Sub https://${UiDistribution.DomainName}/
        # - !If
        #   - useCustomDomainForWebsiteCondition
        #   - !Sub "${WebsiteCustomDomain}user"
        #   - !Sub https://${UiDistribution.DomainName}/user
      LogoutURLs:
        - !If
          - useCustomDomainForWebsiteCondition
          - !Ref WebsiteCustomDomain
          - !Sub https://${UiDistribution.DomainName}/
      AllowedOAuthFlowsUserPoolClient: true
      AllowedOAuthScopes:
        - email
        - phone
        - openid
        - profile
        - aws.cognito.signin.user.admin
      AllowedOAuthFlows:
        - code
      SupportedIdentityProviders:
        - COGNITO
  # local web userpool client
  WebsiteUserPoolClientLocal:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub ${Prefix}_website_app_client_local
      UserPoolId: !Ref WebsiteUserPool
      RefreshTokenValidity: 5
      ExplicitAuthFlows:
        - "ALLOW_REFRESH_TOKEN_AUTH"
        - "ALLOW_USER_AUTH"
        - "ALLOW_USER_SRP_AUTH"
      PreventUserExistenceErrors: "ENABLED"
      SupportedIdentityProviders:
        - "COGNITO"
      CallbackURLs:
        - "http://localhost:8080/"
        - "http://localhost:8080/user"
      LogoutURLs:
        - "http://localhost:8080/"
      AllowedOAuthFlows:
        - "code"
      AllowedOAuthScopes:
        - email
        - phone
        - openid
        - profile
        - aws.cognito.signin.user.admin
      AllowedOAuthFlowsUserPoolClient: true
      IdTokenValidity: 60
      AccessTokenValidity: 60
      TokenValidityUnits:
        AccessToken: "minutes"
        IdToken: "minutes"
        RefreshToken: "days"

  # Identity Pool
  WebsiteIdentityPool:
    Type: AWS::Cognito::IdentityPool
    Properties:
      IdentityPoolName: !Sub ${Prefix}_website_identity_pool
      AllowUnauthenticatedIdentities: true
      CognitoIdentityProviders:
        - ClientId: !Ref WebsiteUserPoolClient
          ProviderName: !GetAtt WebsiteUserPool.ProviderName
        - ClientId: !Ref WebsiteUserPoolClientLocal
          ProviderName: !GetAtt WebsiteUserPool.ProviderName

  # IAM Roles for Authenticated Users
  WebsiteCognitoAuthRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${Prefix}_website_CognitoAuthRole
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Federated: cognito-identity.amazonaws.com
            Action:
              - sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                cognito-identity.amazonaws.com:aud: !Ref WebsiteIdentityPool
      Policies:
        - PolicyName: WebsiteCognitoAuthPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - mobileanalytics:PutEvents
                  - cognito-sync:*
                  - cognito-identity:*
                Resource: "*"
              - Effect: Allow
                Action:
                  - lambda:InvokeFunctionUrl
                Resource: "*"

  # Identity Pool Role Attachment
  WebsiteIdentityPoolRoleAttachment:
    Type: AWS::Cognito::IdentityPoolRoleAttachment
    Properties:
      IdentityPoolId: !Ref WebsiteIdentityPool
      Roles:
        authenticated: !GetAtt WebsiteCognitoAuthRole.Arn

  ManagedLoginBranding:
    Type: AWS::Cognito::ManagedLoginBranding
    Properties:
      UserPoolId: !Ref WebsiteUserPool
      ClientId: !Ref WebsiteUserPoolClient
      UseCognitoProvidedValues: true

  ManagedLoginBrandingLocal:
    Type: AWS::Cognito::ManagedLoginBranding
    Properties:
      UserPoolId: !Ref WebsiteUserPool
      ClientId: !Ref WebsiteUserPoolClientLocal
      UseCognitoProvidedValues: true
  # #ebook api
  # ebookAPI:
  #   Type: AWS::Serverless::Api
  #   Properties:
  #     Name: !Sub ${Prefix}-ebook-api
  #     StageName: !Sub ${Prefix}-ebook-api
  #     EndpointConfiguration: REGIONAL
  #     Cors:
  #       AllowMethods: "'OPTIONS,GET,POST,PUT,DELETE'"
  #       AllowHeaders: "'*'"
  #       AllowOrigin: "'*'"
  #       MaxAge: 3000
  # Auth:
  #   DefaultAuthorizer: MyCognitoAuthorizer
  #   Authorizers:
  #     MyCognitoAuthorizer:
  #       UserPoolArn: !GetAtt WebsiteUserPool.Arn

  # Domain:
  #   DomainName: !Ref UiCustomDomain
  #   CertificateArn: !Ref UiCertificateArn

  # ebook api lambda
  ebookExpressAPILambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${Prefix}_ebook_admin_api
      CodeUri: ebook-api/
      Handler: index.handler
      Timeout: 30
      MemorySize: 256
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      FunctionUrlConfig:
        AuthType: AWS_IAM
        Cors:
          AllowOrigins:
            - "*"
          AllowMethods:
            - "*"
          AllowHeaders:
            - "*"
      ReservedConcurrentExecutions: 15
      Environment:
        Variables:
          DDB_TABLE_NAME: !Ref masterTable
          POWERTOOLS_SERVICE_NAME: express-api
          POWERTOOLS_METRICS_NAMESPACE: ksriadmin
          LOG_LEVEL: INFO
          # USER_POOL_ID: !Ref CognitoUserPool
          # CLIENT_ID: !Ref ProdCognitoUserPoolClient
          # BASE_URL: "https://ksri.in/"
          # EMAIL_PARAM_NAME: "/loops/ksri/key"
          # EVENT_BUS_NAME: !GetAtt customEventBus.Name
          CC_AVENUE_CREDS: "/ksri/ccavenue/purchase"
          CLOUDFLARE_SECRET_KEY: "/cloudflare/trunstile"
          S3_BUCKET_NAME: !Ref S3BucketForEbook
          EBOOK_CLOUDFRONT: !Sub https://${ebookDistribution.DomainName}
          REGION: !Sub ${AWS::Region}
          USER_POOL_ID: !Ref WebsiteUserPool
          CLIENT_ID: !Ref WebsiteUserPoolClient
          CLOUDFRONT_PRIVATE_KEY_PARAM_NAME: /cloudfront/ebook/privateKey
          CLOUDFRONT_KEY_PAIR_ID_PARAM_NAME: !Ref CloudFrontPublicKey
          # ALLOWED_URL: !If
          #   - useCustomDomainForUiCondition
          #   - !Ref UiCustomDomain
          #   - !Sub https://${UiDistribution.DomainName}
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref masterTable
        - DynamoDBReadPolicy:
            TableName: !Ref masterTable
        - DynamoDBWritePolicy:
            TableName: !Ref masterTable
        - SSMParameterReadPolicy:
            ParameterName: "*"
        # event bridge publish permission
        - Statement:
            - Effect: Allow
              Action:
                - events:*
              Resource: "*"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - cognito-idp:*
              Resource: "*"
        - S3CrudPolicy:
            BucketName: !Ref S3BucketForEbook
      # Events:
      #   Api:
      #     Type: Api
      #     Properties:
      #       Path: /{proxy+}
      #       Method: ANY
      #       RestApiId: !Ref ebookAPI

    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        EntryPoints:
          - index.ts

  # purchase api lambda
  purchaseApiHandlerApi:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${Prefix}_purchase_api
      CodeUri: purchase-api-handle-response/
      Handler: index.handler
      Timeout: 30
      MemorySize: 256
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      FunctionUrlConfig:
        AuthType: NONE
        Cors:
          AllowOrigins:
            - "*"
          AllowMethods:
            - "*"
          AllowHeaders:
            - "*"
      ReservedConcurrentExecutions: 15
      Environment:
        Variables:
          DDB_TABLE_NAME: !Ref masterTable
          POWERTOOLS_SERVICE_NAME: express-api
          POWERTOOLS_METRICS_NAMESPACE: ksriadmin
          LOG_LEVEL: INFO
          # USER_POOL_ID: !Ref CognitoUserPool
          # CLIENT_ID: !Ref ProdCognitoUserPoolClient
          # BASE_URL: "https://ksri.in/"
          # EMAIL_PARAM_NAME: "/loops/ksri/key"
          EVENT_BUS_NAME: !GetAtt customEventBus.Name
          CC_AVENUE_CREDS: "/ksri/ccavenue/purchase"
          CLOUDFLARE_SECRET_KEY: "/cloudflare/trunstile"
          S3_BUCKET_NAME: !Ref S3BucketForEbook
          EBOOK_CLOUDFRONT: !Sub https://${ebookDistribution.DomainName}
          REGION: !Sub ${AWS::Region}
          USER_POOL_ID: !Ref WebsiteUserPool
          CLIENT_ID: !Ref WebsiteUserPoolClient
          # ALLOWED_URL: !If
          #   - useCustomDomainForUiCondition
          #   - !Ref UiCustomDomain
          #   - !Sub https://${UiDistribution.DomainName}
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref masterTable
        - DynamoDBReadPolicy:
            TableName: !Ref masterTable
        - DynamoDBWritePolicy:
            TableName: !Ref masterTable
        - SSMParameterReadPolicy:
            ParameterName: "*"
        # event bridge publish permission
        - Statement:
            - Effect: Allow
              Action:
                - events:*
              Resource: "*"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - cognito-idp:*
              Resource: "*"
        - S3CrudPolicy:
            BucketName: !Ref S3BucketForEbook
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        EntryPoints:
          - index.ts

  # purchase email notification lambda
  purchaseEMailNotificationHandler:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${Prefix}_purchase_email_notification
      CodeUri: purchase_email_notification/
      Handler: index.handler
      Timeout: 30
      MemorySize: 256
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      FunctionUrlConfig:
        AuthType: NONE
        Cors:
          AllowOrigins:
            - "*"
          AllowMethods:
            - "*"
          AllowHeaders:
            - "*"
      ReservedConcurrentExecutions: 15
      Environment:
        Variables:
          DDB_TABLE_NAME: !Ref masterTable
          POWERTOOLS_SERVICE_NAME: express-api
          POWERTOOLS_METRICS_NAMESPACE: ksriadmin
          LOG_LEVEL: INFO
          # USER_POOL_ID: !Ref CognitoUserPool
          # CLIENT_ID: !Ref ProdCognitoUserPoolClient
          # BASE_URL: "https://ksri.in/"
          EMAIL_PARAM_NAME: "/loops/ksri/key"
          # EVENT_BUS_NAME: !GetAtt customEventBus.Name
          CC_AVENUE_CREDS: "/ksri/ccavenue/purchase"
          CLOUDFLARE_SECRET_KEY: "/cloudflare/trunstile"
          S3_BUCKET_NAME: !Ref S3BucketForEbook
          EBOOK_CLOUDFRONT: !Sub https://${ebookDistribution.DomainName}
          REGION: !Sub ${AWS::Region}
          USER_POOL_ID: !Ref WebsiteUserPool
          CLIENT_ID: !Ref WebsiteUserPoolClient
          KSRI_EMAIL: "ksrinst@gmail.com"
          # ALLOWED_URL: !If
          #   - useCustomDomainForUiCondition
          #   - !Ref UiCustomDomain
          #   - !Sub https://${UiDistribution.DomainName}
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref masterTable
        - DynamoDBReadPolicy:
            TableName: !Ref masterTable
        - DynamoDBWritePolicy:
            TableName: !Ref masterTable
        - SSMParameterReadPolicy:
            ParameterName: "*"
      Events:
        PaymentCompletedEvent:
          Type: EventBridgeRule
          Properties:
            EventBusName: !GetAtt customEventBus.Name
            Pattern:
              detail-type:
                - payment.purchase.completed
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        EntryPoints:
          - index.ts

Outputs:
  UserPoolId:
    Value: !Ref CognitoUserPool
  LocalAppClientId:
    Value: !Ref CognitoUserPoolClient
  ProdAppClientId:
    Value: !Ref ProdCognitoUserPoolClient
  IdentityPoolId:
    Value: !Ref CognitoIdentityPool
  Domain:
    Value: !Sub ${CognitoUserPoolDomain}.auth.${AWS::Region}.amazoncognito.com
  S3Bucket:
    Value: !Ref S3Bucket
  DDBName:
    Value: !Ref masterTable
  AmplifyApp:
    Value: !Sub https://prod.${AmplifyApp.DefaultDomain}/
  UiDistribution:
    Value: !GetAtt UiDistribution.DomainName
  imageDistribution:
    Value: !GetAtt imageDistribution.DomainName
  expressAPIUrl:
    Value: !GetAtt expressAPIUrl.FunctionUrl
  # WebsiteBucketName:
  #   Description: "Name of S3 bucket hosting the website"
  #   Value: !Ref StaticWebsiteBucket
  # CloudFrontDomainName:
  #   Description: "Domain name of CloudFront distribution"
  #   Value: !GetAtt CloudFrontDistribution.DomainName
  WebsiteURL:
    Description: "URL of the website"
    Value: !GetAtt websiteDistribution.DomainName
  contactUs:
    Value: !GetAtt contactUsUrl.FunctionUrl
